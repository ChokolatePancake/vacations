uuid: fc016784-7386-4ce5-811c-e8a723e26d66
langcode: en
status: true
dependencies:
  config:
    - field.field.node.certificate.field_expiration_date
    - field.field.node.certificate.field_starting_days_number
    - field.field.node.certificate.field_user
    - field.field.node.certificate_flow.field_certificate
    - field.field.node.certificate_flow.field_days
    - field.field.node.certificate_flow.field_operation
    - field.field.node.certificate_flow.field_operation_with_days
    - field.field.node.certificate_template.field_expiration_period
    - field.field.node.certificate_template.field_number_of_days
    - field.field.node.vacations.field_date
    - field.field.node.vacations.field_full_days
    - field.field.user.user.field_available_days
    - field.field.user.user.field_regular_certificate_templa
    - field.storage.node.field_certificate
    - field.storage.node.field_date
    - field.storage.node.field_days
    - field.storage.node.field_expiration_date
    - field.storage.node.field_expiration_period
    - field.storage.node.field_full_days
    - field.storage.node.field_number_of_days
    - field.storage.node.field_operation
    - field.storage.node.field_operation_with_days
    - field.storage.node.field_starting_days_number
    - field.storage.node.field_user
    - field.storage.user.field_available_days
    - field.storage.user.field_regular_certificate_templa
    - node.type.certificate
    - node.type.certificate_flow
    - node.type.vacations
    - views.view.certificates
  module:
    - eca_base
    - eca_content
    - eca_flag
    - eca_log
    - eca_queue
    - eca_tamper
    - eca_views
    - user
id: process_d524j1k
modeller: bpmn_io
label: noname
version: ''
weight: 0
events:
  Event_1lp4or2:
    plugin: 'content_entity:insert'
    label: Event_1lp4or2
    configuration:
      type: 'user user'
    successors:
      -
        id: Activity_1iigodt
        condition: ''
  Event_0yekq4q:
    plugin: 'eca_queue:processing_task'
    label: Event_0yekq4q
    configuration:
      distribute: false
      task_name: give_certificate
      task_value: ''
      cron: '60'
    successors:
      -
        id: Activity_1o6mgkq
        condition: Flow_0yq0jwy
  Event_09ycnmd:
    plugin: 'content_entity:insert'
    label: Event_09ycnmd
    configuration:
      type: 'node certificate_flow'
    successors:
      -
        id: Activity_1lo70pw
        condition: ''
  Event_08pkbbv:
    plugin: 'content_entity:insert'
    label: Event_08pkbbv
    configuration:
      type: 'node vacations'
    successors:
      -
        id: Activity_011v1oh
        condition: ''
  Event_0tbybkg:
    plugin: 'flag:flag'
    label: Event_0tbybkg
    configuration: {  }
    successors:
      -
        id: Activity_1p6780b
        condition: ''
  Event_0vjqee8:
    plugin: 'content_entity:insert'
    label: Event_0vjqee8
    configuration:
      type: 'node vacations'
    successors:
      -
        id: Activity_0210lgf
        condition: Flow_0t0a63k
conditions:
  Flow_0yq0jwy:
    plugin: eca_entity_exists
    configuration:
      negate: false
      unchanged: false
      latest_revision: false
      from: id
      entity_type: user
      entity_id: '[created-user:uid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      entity: created-user
  Flow_1027xb1:
    plugin: eca_scalar
    configuration:
      case: false
      left: '[operation-with-days]'
      right: '0'
      operator: equal
      type: value
      negate: true
  Flow_16b4ebh:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[operation-with-days]'
      right: '0'
      operator: equal
      type: value
  Flow_0t0a63k:
    plugin: eca_entity_field_value
    configuration:
      negate: false
      case: false
      expected_value: '1'
      field_name: field_is_paid
      operator: equal
      type: value
      entity: ''
gateways: {  }
actions:
  Activity_1rgszo3:
    plugin: eca_enqueue_task_delayed
    label: 'Wait 6 months'
    configuration:
      delay_value: '10'
      delay_unit: '1'
      task_name: give_certificate
      task_value: ''
      tokens: 'created-user, template'
    successors: {  }
  Activity_1o6mgkq:
    plugin: eca_new_entity
    label: 'Create regular certificate'
    configuration:
      token_name: certificate
      type: 'node certificate'
      langcode: _interface
      label: 'Regular certificate'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_12o5wvl
        condition: ''
  Activity_1yd3qbq:
    plugin: eca_set_field_value
    label: 'Set starting number of days in certificate'
    configuration:
      field_name: field_starting_days_number.value
      field_value: '[template:field_number_of_days]'
      method: 'set:empty'
      strip_tags: false
      trim: false
      save_entity: true
      object: certificate
    successors:
      -
        id: Activity_1tpd9sk
        condition: ''
  Activity_03fxg1u:
    plugin: eca_set_field_value
    label: 'Set expiration for certificate'
    configuration:
      field_name: field_expiration_date.value
      field_value: '[expiration-date]'
      method: 'set:empty'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate
    successors:
      -
        id: Activity_1yd3qbq
        condition: ''
  Activity_18jucyp:
    plugin: eca_set_field_value
    label: 'Put user information to certificate'
    configuration:
      field_name: field_user.target_id
      field_value: '[created-user:uid]'
      method: 'set:empty'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate
    successors:
      -
        id: Activity_0p8pwgo
        condition: ''
  Activity_1iigodt:
    plugin: eca_token_load_entity_ref
    label: "Load user's certificate template"
    configuration:
      field_name_entity_ref: field_regular_certificate_templa
      token_name: template
      from: current
      entity_type: node
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_10ezw9r
        condition: ''
  Activity_10ezw9r:
    plugin: eca_token_load_entity
    label: 'Load user'
    configuration:
      token_name: created-user
      from: current
      entity_type: user
      entity_id: '[user:uid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_1rgszo3
        condition: ''
  Activity_0f9v5xr:
    plugin: eca_enqueue_task_delayed
    label: 'Wait again'
    configuration:
      delay_value: '10'
      delay_unit: '1'
      task_name: give_certificate
      task_value: ''
      tokens: 'created-user, template'
    successors: {  }
  Activity_12o5wvl:
    plugin: eca_new_entity
    label: 'Create record in flow'
    configuration:
      token_name: certificate-flow
      type: 'node certificate_flow'
      langcode: ''
      label: 'Creating regular certificate'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_18jucyp
        condition: ''
  Activity_1tpd9sk:
    plugin: eca_set_field_value
    label: 'Put certificate to flow'
    configuration:
      field_name: field_certificate.target_id
      field_value: '[certificate:nid]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate-flow
    successors:
      -
        id: Activity_1x8u75x
        condition: ''
  Activity_1x8u75x:
    plugin: eca_set_field_value
    label: 'Set operation'
    configuration:
      field_name: field_operation.target_id
      field_value: '1'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate-flow
    successors:
      -
        id: Activity_05vtl7d
        condition: ''
  Activity_05vtl7d:
    plugin: eca_set_field_value
    label: 'Set operation with days'
    configuration:
      field_name: field_operation_with_days.value
      field_value: '[template:field_number_of_days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate-flow
    successors:
      -
        id: Activity_13jr03y
        condition: ''
  Activity_13jr03y:
    plugin: eca_set_field_value
    label: 'Set days'
    configuration:
      field_name: field_days.value
      field_value: '[template:field_number_of_days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: true
      object: certificate-flow
    successors:
      -
        id: Activity_0f9v5xr
        condition: ''
  Activity_144qdyn:
    plugin: eca_token_load_entity_ref
    label: 'Load certificate'
    configuration:
      field_name_entity_ref: field_certificate
      token_name: certificate
      from: current
      entity_type: node
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_08qvzji
        condition: ''
  Activity_08qvzji:
    plugin: eca_token_load_entity_ref
    label: 'Load user'
    configuration:
      field_name_entity_ref: field_user
      token_name: certificate-user
      from: current
      entity_type: user
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: certificate
    successors:
      -
        id: Activity_1driwde
        condition: ''
  Activity_1driwde:
    plugin: eca_get_field_value
    label: 'Get available days from user'
    configuration:
      field_name: field_available_days
      token_name: available-days
      object: certificate-user
    successors:
      -
        id: Activity_069nqim
        condition: Flow_1027xb1
      -
        id: Activity_1dp9cir
        condition: Flow_16b4ebh
  Activity_1lo70pw:
    plugin: eca_get_field_value
    label: 'Get operations-with-days from flow'
    configuration:
      field_name: field_operation_with_days
      token_name: operation-with-days
      object: ''
    successors:
      -
        id: Activity_144qdyn
        condition: ''
  Activity_069nqim:
    plugin: 'eca_tamper:math'
    label: 'Sum operations-with-days with available-days'
    configuration:
      operation: addition
      flip: false
      value: '[available-days]'
      eca_data: '[operation-with-days]'
      eca_token_name: current-available-days
    successors:
      -
        id: Activity_104k1js
        condition: ''
  Activity_104k1js:
    plugin: eca_set_field_value
    label: 'Save new available-days value'
    configuration:
      field_name: field_available_days
      field_value: '[current-available-days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: true
      object: certificate-user
    successors: {  }
  Activity_034m0q8:
    plugin: 'eca_tamper:math'
    label: 'Subtract remaining days when the certificate is burned'
    configuration:
      operation: subtraction
      flip: false
      value: '[remaining-days]'
      eca_data: '[available-days]'
      eca_token_name: current-available-days
    successors:
      -
        id: Activity_104k1js
        condition: ''
  Activity_1dp9cir:
    plugin: eca_get_field_value
    label: 'Load remaining days from flow'
    configuration:
      field_name: field_days
      token_name: remaining-days
      object: ''
    successors:
      -
        id: Activity_034m0q8
        condition: ''
  Activity_0p8pwgo:
    plugin: 'eca_tamper:math'
    label: 'Count expiration time in seconds'
    configuration:
      operation: multiplication
      flip: false
      value: '2629800'
      eca_data: '[template:field_expiration_period:value]'
      eca_token_name: expiration-time
    successors:
      -
        id: Activity_0iblsno
        condition: ''
  Activity_0iblsno:
    plugin: 'eca_tamper:math'
    label: 'Count expiration date'
    configuration:
      operation: addition
      flip: false
      value: '[expiration-time]'
      eca_data: '[current-date:raw]'
      eca_token_name: expiration-date
    successors:
      -
        id: Activity_03fxg1u
        condition: ''
  Activity_0xf6sei:
    plugin: 'eca_tamper:math'
    label: Subdivide
    configuration:
      operation: subtraction
      flip: false
      value: '[value]'
      eca_data: '[end_value]'
      eca_token_name: full_days_unix
    successors:
      -
        id: Activity_0ephzfw
        condition: ''
  Activity_0mq0mys:
    plugin: eca_set_field_value
    label: 'Set days'
    configuration:
      field_name: field_full_days
      field_value: '[full_days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: true
      object: vacation
    successors: {  }
  Activity_011v1oh:
    plugin: eca_token_load_entity
    label: 'Load vacation'
    configuration:
      token_name: vacation
      from: current
      entity_type: _none
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_0swg1kl
        condition: ''
  Activity_0swg1kl:
    plugin: 'eca_tamper:strtotime'
    label: 'Get start date in UNIX'
    configuration:
      eca_data: '[vacation:field_date:value]'
      eca_token_name: value
    successors:
      -
        id: Activity_1wcwozg
        condition: ''
  Activity_1wcwozg:
    plugin: 'eca_tamper:strtotime'
    label: 'Get end date in UNIX'
    configuration:
      eca_data: '[vacation:field_date:end_value]'
      eca_token_name: end_value
    successors:
      -
        id: Activity_0xf6sei
        condition: ''
  Activity_0ephzfw:
    plugin: 'eca_tamper:math'
    label: 'UNIX to days'
    configuration:
      operation: division
      flip: false
      value: '86400'
      eca_data: '[full_days_unix]'
      eca_token_name: full_days_without_1
    successors:
      -
        id: Activity_1wh2kg4
        condition: ''
  Activity_1wh2kg4:
    plugin: 'eca_tamper:math'
    label: '+1 day'
    configuration:
      operation: addition
      flip: false
      value: '1'
      eca_data: '[full_days_without_1]'
      eca_token_name: full_days
    successors:
      -
        id: Activity_0mq0mys
        condition: ''
  Activity_0pmmj1g:
    plugin: eca_token_load_entity
    label: Activity_0pmmj1g
    configuration:
      token_name: vacation
      from: id
      entity_type: node
      entity_id: '[flag:entity-id]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: flag
    successors:
      -
        id: Activity_0fz1ody
        condition: ''
  Activity_1p6780b:
    plugin: eca_token_load_entity
    label: Activity_1p6780b
    configuration:
      token_name: flag
      from: current
      entity_type: flagging
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_0ss0zme
        condition: ''
  Activity_0fz1ody:
    plugin: eca_write_log_message
    label: Activity_0fz1ody
    configuration:
      channel: euo
      severity: '2'
      message: |-
        [vacation:title] title
        [flag:entity-id] entity id
    successors: {  }
  Activity_0ss0zme:
    plugin: eca_write_log_message
    label: Activity_0ss0zme
    configuration:
      channel: ''
      severity: '2'
      message: '[flag:entity-id]'
    successors:
      -
        id: Activity_0pmmj1g
        condition: ''
  Activity_0vg9uzk:
    plugin: eca_token_load_entity_ref
    label: 'Load user'
    configuration:
      field_name_entity_ref: uid
      token_name: current-user
      from: current
      entity_type: user
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_156bcft
        condition: ''
  Activity_156bcft:
    plugin: eca_views_query
    label: 'Execute query'
    configuration:
      token_name: view
      view_id: certificates
      display_id: default
      arguments: '[current-user:uid]'
    successors:
      -
        id: Activity_1pjlvec
        condition: ''
  Activity_0210lgf:
    plugin: eca_get_field_value
    label: 'Get number of required days'
    configuration:
      field_name: field_full_days
      token_name: full-days
      object: ''
    successors:
      -
        id: Activity_0vg9uzk
        condition: ''
  Activity_1pjlvec:
    plugin: eca_write_log_message
    label: Activity_1pjlvec
    configuration:
      channel: uek
      severity: '3'
      message: |-
        [view] 	[view:id]
        [view:total-rows] 	
        [view:url]
    successors: {  }
