uuid: 5367b0b3-46a9-4e9f-b2d7-a05a10fa3126
langcode: en
status: true
dependencies:
  config:
    - field.field.node.certificate.field_expiration_date
    - field.field.node.certificate.field_starting_days_number
    - field.field.node.certificate.field_user
    - field.field.node.certificate_flow.field_certificate
    - field.field.node.certificate_flow.field_days
    - field.field.node.certificate_flow.field_operation
    - field.field.node.certificate_flow.field_operation_with_days
    - field.field.node.certificate_template.field_expiration_period
    - field.field.node.certificate_template.field_number_of_days
    - field.field.user.user.field_available_days
    - field.field.user.user.field_regular_certificate_templa
    - field.storage.node.field_certificate
    - field.storage.node.field_days
    - field.storage.node.field_expiration_date
    - field.storage.node.field_expiration_period
    - field.storage.node.field_number_of_days
    - field.storage.node.field_operation
    - field.storage.node.field_operation_with_days
    - field.storage.node.field_starting_days_number
    - field.storage.node.field_user
    - field.storage.user.field_available_days
    - field.storage.user.field_regular_certificate_templa
    - node.type.certificate
    - node.type.certificate_flow
  module:
    - eca_base
    - eca_content
    - eca_queue
    - eca_tamper
    - user
id: process_gkx1qei
modeller: bpmn_io
label: Certificates
version: ''
weight: 0
events:
  Event_1lp4or2:
    plugin: 'content_entity:insert'
    label: Event_1lp4or2
    configuration:
      type: 'user user'
    successors:
      -
        id: Activity_1iigodt
        condition: ''
  Event_0yekq4q:
    plugin: 'eca_queue:processing_task'
    label: Event_0yekq4q
    configuration:
      distribute: false
      task_name: give_certificate
      task_value: ''
      cron: '60'
    successors:
      -
        id: Activity_1o6mgkq
        condition: Flow_0yq0jwy
  Event_09ycnmd:
    plugin: 'content_entity:insert'
    label: Event_09ycnmd
    configuration:
      type: 'node certificate_flow'
    successors:
      -
        id: Activity_1lo70pw
        condition: ''
conditions:
  Flow_0yq0jwy:
    plugin: eca_entity_exists
    configuration:
      negate: false
      unchanged: false
      latest_revision: false
      from: id
      entity_type: user
      entity_id: '[created-user:uid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      entity: created-user
  Flow_1027xb1:
    plugin: eca_scalar
    configuration:
      case: false
      left: '[operation-with-days]'
      right: '0'
      operator: equal
      type: value
      negate: true
  Flow_16b4ebh:
    plugin: eca_scalar
    configuration:
      negate: false
      case: false
      left: '[operation-with-days]'
      right: '0'
      operator: equal
      type: value
gateways: {  }
actions:
  Activity_1rgszo3:
    plugin: eca_enqueue_task_delayed
    label: 'Wait 6 months'
    configuration:
      delay_value: '10'
      delay_unit: '1'
      task_name: give_certificate
      task_value: ''
      tokens: 'created-user, template'
    successors: {  }
  Activity_1o6mgkq:
    plugin: eca_new_entity
    label: 'Create regular certificate'
    configuration:
      token_name: certificate
      type: 'node certificate'
      langcode: _interface
      label: 'Regular certificate'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_12o5wvl
        condition: ''
  Activity_1yd3qbq:
    plugin: eca_set_field_value
    label: 'Set starting number of days in certificate'
    configuration:
      field_name: field_starting_days_number.value
      field_value: '[template:field_number_of_days]'
      method: 'set:empty'
      strip_tags: false
      trim: false
      save_entity: true
      object: certificate
    successors:
      -
        id: Activity_1tpd9sk
        condition: ''
  Activity_03fxg1u:
    plugin: eca_set_field_value
    label: 'Set expiration for certificate'
    configuration:
      field_name: field_expiration_date.value
      field_value: '[expiration-date]'
      method: 'set:empty'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate
    successors:
      -
        id: Activity_1yd3qbq
        condition: ''
  Activity_18jucyp:
    plugin: eca_set_field_value
    label: 'Put user information to certificate'
    configuration:
      field_name: field_user.target_id
      field_value: '[created-user:uid]'
      method: 'set:empty'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate
    successors:
      -
        id: Activity_0p8pwgo
        condition: ''
  Activity_1iigodt:
    plugin: eca_token_load_entity_ref
    label: "Load user's certificate template"
    configuration:
      field_name_entity_ref: field_regular_certificate_templa
      token_name: template
      from: current
      entity_type: node
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_10ezw9r
        condition: ''
  Activity_10ezw9r:
    plugin: eca_token_load_entity
    label: 'Load user'
    configuration:
      token_name: created-user
      from: current
      entity_type: user
      entity_id: '[user:uid]'
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_1rgszo3
        condition: ''
  Activity_0f9v5xr:
    plugin: eca_enqueue_task_delayed
    label: 'Wait again'
    configuration:
      delay_value: '10'
      delay_unit: '1'
      task_name: give_certificate
      task_value: ''
      tokens: 'created-user, template'
    successors: {  }
  Activity_12o5wvl:
    plugin: eca_new_entity
    label: 'Create record in flow'
    configuration:
      token_name: certificate-flow
      type: 'node certificate_flow'
      langcode: ''
      label: 'Creating regular certificate'
      published: true
      owner: '1'
    successors:
      -
        id: Activity_18jucyp
        condition: ''
  Activity_1tpd9sk:
    plugin: eca_set_field_value
    label: 'Put certificate to flow'
    configuration:
      field_name: field_certificate.target_id
      field_value: '[certificate:nid]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate-flow
    successors:
      -
        id: Activity_1x8u75x
        condition: ''
  Activity_1x8u75x:
    plugin: eca_set_field_value
    label: 'Set operation'
    configuration:
      field_name: field_operation.target_id
      field_value: '1'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate-flow
    successors:
      -
        id: Activity_05vtl7d
        condition: ''
  Activity_05vtl7d:
    plugin: eca_set_field_value
    label: 'Set operation with days'
    configuration:
      field_name: field_operation_with_days.value
      field_value: '[template:field_number_of_days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: false
      object: certificate-flow
    successors:
      -
        id: Activity_13jr03y
        condition: ''
  Activity_13jr03y:
    plugin: eca_set_field_value
    label: 'Set days'
    configuration:
      field_name: field_days.value
      field_value: '[template:field_number_of_days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: true
      object: certificate-flow
    successors:
      -
        id: Activity_0f9v5xr
        condition: ''
  Activity_144qdyn:
    plugin: eca_token_load_entity_ref
    label: 'Load certificate'
    configuration:
      field_name_entity_ref: field_certificate
      token_name: certificate
      from: current
      entity_type: node
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: ''
    successors:
      -
        id: Activity_08qvzji
        condition: ''
  Activity_08qvzji:
    plugin: eca_token_load_entity_ref
    label: 'Load user'
    configuration:
      field_name_entity_ref: field_user
      token_name: certificate-user
      from: current
      entity_type: user
      entity_id: ''
      revision_id: ''
      properties: ''
      langcode: _interface
      latest_revision: false
      unchanged: false
      object: certificate
    successors:
      -
        id: Activity_1driwde
        condition: ''
  Activity_1driwde:
    plugin: eca_get_field_value
    label: 'Get available days from user'
    configuration:
      field_name: field_available_days
      token_name: available-days
      object: certificate-user
    successors:
      -
        id: Activity_069nqim
        condition: Flow_1027xb1
      -
        id: Activity_1dp9cir
        condition: Flow_16b4ebh
  Activity_1lo70pw:
    plugin: eca_get_field_value
    label: 'Get operations-with-days from flow'
    configuration:
      field_name: field_operation_with_days
      token_name: operation-with-days
      object: ''
    successors:
      -
        id: Activity_144qdyn
        condition: ''
  Activity_069nqim:
    plugin: 'eca_tamper:math'
    label: 'Sum operations-with-days with available-days'
    configuration:
      operation: addition
      flip: false
      value: '[available-days]'
      eca_data: '[operation-with-days]'
      eca_token_name: current-available-days
    successors:
      -
        id: Activity_104k1js
        condition: ''
  Activity_104k1js:
    plugin: eca_set_field_value
    label: 'Save new available-days value'
    configuration:
      field_name: field_available_days
      field_value: '[current-available-days]'
      method: 'set:clear'
      strip_tags: false
      trim: false
      save_entity: true
      object: certificate-user
    successors: {  }
  Activity_034m0q8:
    plugin: 'eca_tamper:math'
    label: 'Subtract remaining days when the certificate is burned'
    configuration:
      operation: subtraction
      flip: false
      value: '[remaining-days]'
      eca_data: '[available-days]'
      eca_token_name: current-available-days
    successors:
      -
        id: Activity_104k1js
        condition: ''
  Activity_1dp9cir:
    plugin: eca_get_field_value
    label: 'Load remaining days from flow'
    configuration:
      field_name: field_days
      token_name: remaining-days
      object: ''
    successors:
      -
        id: Activity_034m0q8
        condition: ''
  Activity_0p8pwgo:
    plugin: 'eca_tamper:math'
    label: 'Count expiration time in seconds'
    configuration:
      operation: multiplication
      flip: false
      value: '2629800'
      eca_data: '[template:field_expiration_period:value]'
      eca_token_name: expiration-time
    successors:
      -
        id: Activity_0iblsno
        condition: ''
  Activity_0iblsno:
    plugin: 'eca_tamper:math'
    label: 'Count expiration date'
    configuration:
      operation: addition
      flip: false
      value: '[expiration-time]'
      eca_data: '[current-date:raw]'
      eca_token_name: expiration-date
    successors:
      -
        id: Activity_03fxg1u
        condition: ''
